{
  "name": "Generate MDX & Commit to GitHub (daily)",
  "nodes": [
    {
      "id": "t",
      "type": "cron",
      "name": "Daily",
      "parameters": {
        "triggerTimes": [
          {
            "hour": 6
          }
        ]
      }
    },
    {
      "id": "getEpisodes",
      "type": "httpRequest",
      "name": "Get Episodes",
      "parameters": {
        "url": "={{$env.DIRECTUS_URL}}/items/rss_episodes",
        "responseFormat": "json"
      }
    },
    {
      "id": "getSnips",
      "type": "httpRequest",
      "name": "Get Snippets",
      "parameters": {
        "url": "={{$env.DIRECTUS_URL}}/items/rss_snippets",
        "responseFormat": "json"
      }
    },
    {
      "id": "build",
      "type": "function",
      "name": "Build MDX Files",
      "parameters": {
        "code": "\nfunction slugify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'').slice(0,80); }\nconst files=[];\nconst eps = items[0].json.data || [];\nconst snips = items[1].json.data || [];\n\nfor(const e of eps){\n  const slug = slugify(e.title);\n  const mdx = `---\ntitle: \"${(e.title||'').replace(/\"/g,'\\\\\"')}\"\ndate: \"${e.pubDate||''}\"\nsource: \"${e.link||''}\"\n---\n\n# ${(e.title||'')}\n\n${e.summary||''}\n\n[Listen now](${e.link||'#'})\n`;\n  files.push({path:`app/episodes/_items/${slug}/page.mdx`, content: mdx});\n}\nfor(const s of snips){\n  const slug = slugify(s.title);\n  const mdx = `---\ntitle: \"${(s.title||'').replace(/\"/g,'\\\\\"')}\"\ndate: \"${s.published||''}\"\nvideoId: \"${s.videoId||''}\"\nsource: \"${s.link||''}\"\n---\n\n# ${(s.title||'')}\n\n<iframe width=\"100%\" height=\"360\" src=\"https://www.youtube.com/embed/${s.videoId||''}\" title=\"${(s.title||'').replace(/\"/g,'\\\\\"')}\" frameborder=\"0\" allowfullscreen></iframe>\n\n[Watch on YouTube](${s.link||'#'})\n`;\n  files.push({path:`app/snippets/_items/${slug}/page.mdx`, content: mdx});\n}\n\nreturn files.map(f=>({json:f}));\n"
      }
    },
    {
      "id": "commit",
      "type": "httpRequest",
      "name": "Commit to GitHub",
      "parameters": {
        "method": "PUT",
        "url": "=https://api.github.com/repos/{{$env.GH_OWNER}}/{{$env.GH_REPO}}/contents/{{$json.path}}",
        "jsonParameters": true,
        "sendBody": true,
        "bodyParametersJson": "={\"message\":\"content: update {{$json.path}}\",\"content\":\"={{Buffer.from($json.content).toString('base64')}}\",\"branch\":\"main\"}",
        "options": {
          "ignoreHttpStatusErrors": true
        }
      }
    }
  ]
}