{
  "name": "Podcast RSS \u2192 Directus (weekly)",
  "nodes": [
    {
      "id": "t",
      "type": "cron",
      "name": "Weekly",
      "parameters": {
        "triggerTimes": [
          {
            "hour": 6,
            "weekday": "monday"
          }
        ]
      }
    },
    {
      "id": "getRSS",
      "type": "httpRequest",
      "name": "Fetch RSS",
      "parameters": {
        "url": "={{$env.PODCAST_RSS}}",
        "responseFormat": "string"
      }
    },
    {
      "id": "parse",
      "type": "function",
      "name": "Parse XML",
      "parameters": {
        "code": "const xml=items[0].json; const {parseString}=require('xml2js'); return new Promise((res,rej)=>parseString(xml,(e,r)=>e?rej(e):res([{json:r}])));"
      }
    },
    {
      "id": "map",
      "type": "function",
      "name": "Map Items",
      "parameters": {
        "code": "const ch=items[0].json.rss.channel[0]; const out=(ch.item||[]).map(it=>({title:it.title?.[0]||'',link:it.link?.[0]||'',pubDate:it.pubDate?.[0]||'',summary:(it['itunes:summary']?.[0]||it.description?.[0]||'').replace(/<[^>]*>/g,'')})); return out.map(j=>({json:j}));"
      }
    },
    {
      "id": "upsert",
      "type": "httpRequest",
      "name": "Upsert to Directus",
      "parameters": {
        "method": "POST",
        "url": "={{$env.DIRECTUS_URL}}/items/rss_episodes",
        "jsonParameters": true,
        "sendBody": true,
        "bodyParametersJson": "={\"batch\":$json}",
        "options": {
          "ignoreHttpStatusErrors": true
        }
      }
    }
  ]
}