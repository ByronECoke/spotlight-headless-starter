{
  "name": "YouTube RSS \u2192 Directus (daily)",
  "nodes": [
    {
      "id": "t",
      "type": "cron",
      "name": "Daily",
      "parameters": {
        "triggerTimes": [
          {
            "hour": 5
          }
        ]
      }
    },
    {
      "id": "getRSS",
      "type": "httpRequest",
      "name": "Fetch RSS",
      "parameters": {
        "url": "=https://www.youtube.com/feeds/videos.xml?channel_id={{$env.YT_CHANNEL_ID}}",
        "responseFormat": "string"
      }
    },
    {
      "id": "parse",
      "type": "function",
      "name": "Parse XML",
      "parameters": {
        "code": "const xml=items[0].json; const {parseString}=require('xml2js'); return new Promise((res,rej)=>parseString(xml,(e,r)=>e?rej(e):res([{json:r}])));"
      }
    },
    {
      "id": "map",
      "type": "function",
      "name": "Map Items",
      "parameters": {
        "code": "const entries=items[0].json.feed.entry||[]; const out=entries.map(en=>({title:en.title?.[0]||'',videoId:en['yt:videoId']?.[0]||'',link:en.link?.[0]?.$.href||'',published:en.published?.[0]||'',thumbnail:`https://i.ytimg.com/vi/${en['yt:videoId']?.[0]}/hqdefault.jpg`})); return out.map(j=>({json:j}));"
      }
    },
    {
      "id": "upsert",
      "type": "httpRequest",
      "name": "Upsert to Directus",
      "parameters": {
        "method": "POST",
        "url": "={{$env.DIRECTUS_URL}}/items/rss_snippets",
        "jsonParameters": true,
        "sendBody": true,
        "bodyParametersJson": "={\"batch\":$json}",
        "options": {
          "ignoreHttpStatusErrors": true
        }
      }
    }
  ]
}